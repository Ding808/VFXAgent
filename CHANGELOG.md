# VFX Director Layer - å˜æ›´æ—¥å¿—\n\n## ç‰ˆæœ¬ä¿¡æ¯\n**ç‰ˆæœ¬**: VFX Director v1.0\n**æ—¥æœŸ**: 2025å¹´2æœˆ\n**æ”¹é©çº§åˆ«**: æ¶æ„æ”¹é€ \n\n---\n\n## æ ¸å¿ƒå˜æ›´\n\n### 1. æ–°å¢æ•°æ®ç»“æ„ (VFXRecipe.h)\n\n#### æšä¸¾\n```cpp\nâœ¨ EVFXArchetype (12ä¸ªå€¼)\n  - Tornado, Explosion, Fire, Smoke, Aura, Trail, Beam, Dust, Sparks, Impact, Custom\n\nâœ¨ EVFXMotionModel (8ä¸ªå€¼)\n  - Radial, RadialInward, Orbit, Vortex, Directional, Vertical, Turbulent, Static\n```\n\n#### ç»“æ„ä½“\n```cpp\nâœ¨ FVFXMotionBehavior\n  - å®šä¹‰è¿åŠ¨æ–¹å¼ã€è½´çº¿ã€é«˜åº¦é©±åŠ¨ç­‰\n\nâœ¨ FVFXPatternAvoidance\n  - å®šä¹‰å“ªäº›Niagara patternsä¸èƒ½ç”¨\n\nâœ¨ FVFXVisualHierarchy\n  - å®šä¹‰è§†è§‰å±‚çº§å’Œä¼˜å…ˆçº§\n\nâœ¨ FVFXIntent  â† æ ¸å¿ƒï¼\n  - æ•´åˆArchetypeã€Motionã€Hierarchyã€Avoidance\n  - è¡¨è¾¾\"è¿™ä¸ªç‰¹æ•ˆåº”è¯¥ä»€ä¹ˆæ ·\"\n\nğŸ”§ FVFXRecipe\n  - æ·»åŠ  Intent å­—æ®µ\n  - ä¿ç•™æ‰€æœ‰ç°æœ‰å­—æ®µï¼Œå‘åå…¼å®¹\n```\n\n### 2. ç³»ç»Ÿæç¤ºè¯æ›´æ–° (HttpLLMProvider.cpp)\n\n#### æ—§ç‰ˆæç¤º\n```\n\"You are a Niagara VFX recipe generator...\"\n\"Output a JSON matching this schema...\"\n```\n\n#### æ–°ç‰ˆæç¤º  âœ¨\n```\n\"You are a VFX director, not a Niagara programmer.\"\n\"Stage 1: Output VFX Intent (semantic understanding)\"\n\"Stage 2: Output Niagara Recipe (matching the intent)\"\n```\n\n**æ–°æç¤ºçš„ç‰¹ç‚¹**ï¼š\n- æ˜ç¡®ä¸¤é˜¶æ®µæµç¨‹\n- æ¯ä¸ªArchetypeçš„ç‰©ç†éœ€æ±‚è¯´æ˜\n- æ˜ç¡®çš„é¿å…patternsåˆ—è¡¨\n- Tornado / Explosion / Fire ç­‰å…·ä½“ä¾‹å­\n\n### 3. è§„åˆ™å¼•æ“ (VFXRecipeCompiler.cpp)\n\n#### æ–°å‡½æ•°\n```cpp\nâœ¨ ApplyArchetypeRules(const FVFXIntent& Intent, \n                       FVFXRecipe& Recipe,\n                       TArray<FString>& OutWarnings)\n```\n\n**Tornadoè§„åˆ™**ï¼š\n- å‡å¼±å‘å¤–çš„InitialVelocity (Ã— 0.3)\n- ç¦ç”¨é‡åŠ›æˆ–å‡å¼±åˆ°10%\n- ç”Ÿæˆ3å±‚ç»“æ„ï¼ˆCoreFunnel, Debris, Dustï¼‰\n- åº”ç”¨é«˜åº¦é©±åŠ¨å‚æ•°\n\n**Explosionè§„åˆ™**ï¼š\n- ä¿ç•™Radial outward motion\n- å¯ç”¨é‡åŠ›(-980)\n- 2-4å±‚ç»“æ„\n\n**Fireè§„åˆ™**ï¼š\n- å¼ºåˆ¶å‘ä¸Šé€Ÿåº¦(Z > 50)\n- å‡å¼±é‡åŠ›(Ã— 0.2)\n- 3å±‚ï¼šflame, ember, smoke\n\n#### ä¿®æ”¹ç°æœ‰å‡½æ•°\n```cpp\nğŸ”§ ValidateAndSanitize()\n  - Step 1: åº”ç”¨Intentè§„åˆ™ï¼ˆæ–°ï¼‰\n  - Step 2: ä¸ºTornadoç”Ÿæˆ3å±‚ï¼ˆæ–°ï¼‰\n  - Step 3: å½’ä¸€åŒ–å‚æ•°ï¼ˆç°æœ‰ï¼‰\n```\n\n---\n\n## æ–‡ä»¶å˜æ›´è¯¦æƒ…\n\n### Source/VFXAgentCore/Public/VFXRecipe.h\n```diff\n- 0 è¡Œ â†’ + 200 è¡Œï¼ˆæ–°å¢ç»“æ„å’Œæšä¸¾ï¼‰\n- æ·»åŠ 11ä¸ªæ–°æšä¸¾å’Œç»“æ„ä½“\n- ä¿®æ”¹FVFXRecipeæ·»åŠ Intentå­—æ®µ\n- ç¼–è¯‘æ£€éªŒ: âœ… æ— é”™è¯¯\n```\n\n### Source/VFXAgentCore/Private/HttpLLMProvider.cpp\n```diff\n- ä¿®æ”¹ BuildSystemPrompt() å‡½æ•°\n  - æ—§æç¤º: ~400è¡Œï¼ˆç›´æ¥å‚æ•°æ¨¡å¼ï¼‰\n  - æ–°æç¤º: ~500è¡Œï¼ˆä¸¤é˜¶æ®µå¯¼æ¼”æ¨¡å¼ï¼‰\n- æ— æ–°å‡½æ•°æ·»åŠ \n- ç°æœ‰å‡½æ•°TryParseRecipeJson()è‡ªåŠ¨æ”¯æŒIntentè§£æ\n- ç¼–è¯‘æ£€éªŒ: âœ… æ— é”™è¯¯\n```\n\n### Source/VFXAgentNiagara/Private/VFXRecipeCompiler.cpp\n```diff\n- 0 è¡Œ â†’ + 150 è¡Œï¼ˆæ–°å¢ApplyArchetypeRuleså‡½æ•°ï¼‰\n- ä¿®æ”¹ ValidateAndSanitize() å‡½æ•°\n  - æ·»åŠ Intentè§„åˆ™åº”ç”¨æ­¥éª¤\n  - æ·»åŠ Tornado 3å±‚è‡ªåŠ¨ç”Ÿæˆé€»è¾‘\n- æ–°å‡½æ•°: ApplyArchetypeRules()\n- ç¼–è¯‘æ£€éªŒ: âœ… æ— é”™è¯¯\n```\n\n---\n\n## åŠŸèƒ½å˜æ›´\n\n### âŒ ç§»é™¤çš„åŠŸèƒ½\næ— ç§»é™¤ã€‚æ‰€æœ‰å˜æ›´éƒ½æ˜¯æ‰©å±•æ€§çš„ï¼Œå‘åå…¼å®¹ã€‚\n\n### âœ¨ æ–°å¢åŠŸèƒ½\n\n#### 1. Intent-Aware Processing\n- ç³»ç»Ÿå¯ä»¥ç†è§£ç‰¹æ•ˆçš„è¯­ä¹‰ç±»å‹\n- æ ¹æ®Archetypeè‡ªåŠ¨åº”ç”¨è§„åˆ™\n- ç¦ç”¨ä¸é€‚ç”¨çš„patterns\n\n#### 2. Tornadoä¿®å¤\n- è‡ªåŠ¨ç”Ÿæˆ3å±‚ç»“æ„\n- å¼ºåˆ¶å‘ä¸Šè¿åŠ¨ï¼ˆç¦ç”¨å‘å¤–ï¼‰\n- ç¦ç”¨é‡åŠ›\n- ç»“æœï¼šçœ‹èµ·æ¥åƒé¾™å·é£ï¼Œä¸æ˜¯çˆ†ç‚¸\n\n#### 3. Archetypeè§„åˆ™\n- Tornado: Vortex motion + Centripetal\n- Explosion: Radial outward + Gravity\n- Fire: Vertical upward + No strong gravity\n- å¯æ‰©å±•åˆ°å…¶ä»–archetype\n\n#### 4. è‡ªåŠ¨ç”Ÿæˆé»˜è®¤ç»“æ„\n- Tornado: 3å±‚ (CoreFunnel, Debris, Dust)\n- æ¯å±‚æœ‰é¢„è®¾çš„SpawnRate, Lifetime, Size\n- ç”¨æˆ·å¯ä¿®æ”¹å‚æ•°ä½†ä¿æŒç»“æ„\n\n#### 5. è¯¦ç»†æ—¥å¿—\n- æ¯ä¸ªåº”ç”¨çš„è§„åˆ™éƒ½æœ‰æ—¥å¿—\n- [TORNADO], [EXPLOSION], [FIRE]ç­‰æ ‡è®°\n- ä¾¿äºè°ƒè¯•å’ŒéªŒè¯\n\n### ğŸ”§ ä¿®æ”¹çš„åŠŸèƒ½\n\n#### 1. LLMæç¤ºè¯\n- ä»\"ç›´æ¥ç”Ÿæˆå‚æ•°\"æ”¹ä¸º\"å…ˆè¾“å‡ºIntentï¼Œåè¾“å‡ºRecipe\"\n- ä»é€šç”¨æ”¹ä¸ºArchetypeç‰¹å®š\n- ä»éšå¼æ”¹ä¸ºæ˜¾å¼çš„é¿å…patternsåˆ—è¡¨\n\n#### 2. RecipeCompileræµç¨‹\n- åŸæµç¨‹: Validate â†’ Sanitize â†’ Compile\n- æ–°æµç¨‹: ApplyRules â†’ AutoGenerate â†’ Validate â†’ Sanitize â†’ Compile\n\n#### 3. JSONè§£æ\n- åŸæ¥åªè§£æemitters\n- ç°åœ¨è‡ªåŠ¨è§£æintent\n- FJsonObjectConverterè‡ªåŠ¨å¤„ç†\n\n---\n\n## å‘åå…¼å®¹æ€§\n\nâœ… **å®Œå…¨å‘åå…¼å®¹**\n\n- ç°æœ‰ä»£ç æ— éœ€æ”¹åŠ¨\n- Intentæ˜¯å¯é€‰çš„ï¼ˆé»˜è®¤Customï¼‰\n- Custom archetypeä¸åº”ç”¨ä»»ä½•è§„åˆ™\n- æ‰€æœ‰æ–°å­—æ®µéƒ½æœ‰é»˜è®¤å€¼\n\n```cpp\n// æ—§ä»£ç ä»ç„¶å·¥ä½œ\nFVFXRecipe OldRecipe;\nOldRecipe.Layers.Add(...);\nUVFXRecipeCompiler::ValidateAndSanitize(OldRecipe, Warnings);\n// ä»ç„¶æœ‰æ•ˆï¼Œåªæ˜¯ä¸ä¼šåº”ç”¨æ–°çš„Intentè§„åˆ™\n\n// æ–°ä»£ç ä½¿ç”¨Intent\nFVFXRecipe NewRecipe;\nNewRecipe.Intent.Archetype = EVFXArchetype::Tornado;\nUVFXRecipeCompiler::ValidateAndSanitize(NewRecipe, Warnings);\n// ç°åœ¨ä¼šåº”ç”¨Tornadoè§„åˆ™\n```\n\n---\n\n## æ€§èƒ½å½±å“\n\n| æ“ä½œ | æ—¶é—´å¢é•¿ | è¯´æ˜ |\n|------|---------|------|\n| ApplyArchetypeRules | < 1ms | æ–°å¢ |\n| 3å±‚è‡ªåŠ¨ç”Ÿæˆ | < 2ms | ä»…Tornado |\n| ValidateAndSanitize | + 3-5ms | æ–°å¢è§„åˆ™åº”ç”¨ |\n| æ€»ç¼–è¯‘æ—¶é—´ | + 5-10ms | æ€»ä½“å½±å“å° |\n| å†…å­˜ | + ~2KB | Intentæ•°æ®ç»“æ„ |\n\n**ç»“è®º**ï¼šæ€§èƒ½å½±å“å¯å¿½ç•¥ã€‚\n\n---\n\n## è¡Œä¸ºå˜æ›´\n\n### ç°è±¡1ï¼šTornadoç‰¹æ•ˆ\n**å‰**ï¼šç«–ç›´å–·å‘çš„ç‚¹äº‘ï¼ˆçœ‹èµ·æ¥åƒçˆ†ç‚¸ï¼‰  \n**å**ï¼šæ¼æ–—å½¢ï¼Œå‘ä¸Šï¼Œåˆ†å±‚ï¼ˆçœ‹èµ·æ¥åƒé¾™å·é£ï¼‰\n\n**åŸå› **ï¼š\n- å‰ï¼šæ— Intentç†è§£ï¼Œç›´æ¥ç”ŸæˆCone velocity + Gravity\n- åï¼šApplyArchetypeRulesç¦ç”¨Coneï¼Œç¦ç”¨Gravityï¼Œç”Ÿæˆ3å±‚\n\n### ç°è±¡2ï¼šWarningæ—¥å¿—\n**å‰**ï¼šé€šç”¨çš„éªŒè¯è­¦å‘Š  \n**å**ï¼šç‰¹å®šçš„[TORNADO]ã€[EXPLOSION]ç­‰æ ‡è®°\n\n**åŸå› **ï¼šApplyArchetypeRulesçš„æ—¥å¿—è¾“å‡º\n\n### ç°è±¡3ï¼šå±‚æ•°\n**å‰**ï¼šä½¿ç”¨LLMç”Ÿæˆçš„å±‚æ•°ï¼ˆå¯èƒ½1-5ä¸ªï¼‰  \n**å**ï¼šTornadoå›ºå®š3å±‚ï¼Œå…¶ä»–archetypeéµå¾ªè§„åˆ™\n\n**åŸå› **ï¼šè‡ªåŠ¨ç”Ÿæˆé»˜è®¤ç»“æ„ä¿è¯ä¸€è‡´æ€§\n\n---\n\n## æ–‡æ¡£å˜æ›´\n\n### æ–°å¢æ–‡æ¡£\n```\nâœ¨ VFX_DIRECTOR_SYSTEM.md (500+ è¡Œ)\n  - å®Œæ•´ç³»ç»Ÿè®¾è®¡å’Œç†è®º\n  - å¯¹æ¯”å‰åæµç¨‹\n  - Tornadoä¿®å¤è¯¦è§£\n\nâœ¨ IMPLEMENTATION_GUIDE.md (400+ è¡Œ)\n  - APIä½¿ç”¨æŒ‡å—\n  - ä»£ç ç¤ºä¾‹\n  - è°ƒè¯•æŠ€å·§\n\nâœ¨ TESTING_GUIDE.md (300+ è¡Œ)\n  - å•å…ƒæµ‹è¯•æ–¹æ¡ˆ\n  - é›†æˆæµ‹è¯•æ–¹æ¡ˆ\n  - æ€§èƒ½æµ‹è¯•\n  - éªŒè¯æ¸…å•\n\nâœ¨ ARCHITECTURE_SUMMARY.md (200+ è¡Œ)\n  - æ”¹é©æ€»ç»“\n  - å…³é”®æ•°å­—\n  - åç»­è¡ŒåŠ¨\n\nâœ¨ QUICK_REFERENCE.md (200+ è¡Œ)\n  - å¿«é€Ÿå‚è€ƒå¡ç‰‡\n  - å¸¸ç”¨å‚æ•°å€¼\n  - å‘½ä»¤é€ŸæŸ¥\n```\n\n### ä¿®æ”¹ç°æœ‰æ–‡æ¡£\næ— ä¿®æ”¹ã€‚å»ºè®®æ·»åŠ åˆ°READMEä¸­\n\n---\n\n## ç¼–è¯‘å’Œæµ‹è¯•\n\n### ç¼–è¯‘çŠ¶æ€\nâœ… VFXRecipe.h - æ— é”™è¯¯\nâœ… HttpLLMProvider.cpp - æ— é”™è¯¯  \nâœ… VFXRecipeCompiler.cpp - æ— é”™è¯¯\n\n### å»ºè®®çš„æµ‹è¯•\n```cpp\nâ–¡ å•å…ƒæµ‹è¯•: Intentè§£æ\nâ–¡ å•å…ƒæµ‹è¯•: Tornadoè§„åˆ™åº”ç”¨\nâ–¡ å•å…ƒæµ‹è¯•: 3å±‚è‡ªåŠ¨ç”Ÿæˆ\nâ–¡ é›†æˆæµ‹è¯•: LLMè¾“å‡ºâ†’è§£æâ†’åº”ç”¨è§„åˆ™\nâ–¡ å¯¹æ¯”æµ‹è¯•: Tornado vs Explosion\nâ–¡ æ€§èƒ½æµ‹è¯•: ç¼–è¯‘æ—¶é—´\nâ–¡ å¯è§†åŒ–æµ‹è¯•: Niagaraç³»ç»Ÿé¢„è§ˆ\n```\n\nè¯¦è§ [TESTING_GUIDE.md](TESTING_GUIDE.md)\n\n---\n\n## ä¾èµ–å…³ç³»\n\n### æ–°å¢ä¾èµ–\næ— ã€‚æ‰€æœ‰æ–°ä»£ç åªä¾èµ–ç°æœ‰çš„Unreal Engineç±»ã€‚\n\n### å¯èƒ½å½±å“çš„æ¨¡å—\n- VFXAgentCore - æ–°å¢VFXIntentç›¸å…³\n- VFXAgentNiagara - æ–°å¢è§„åˆ™å¼•æ“\n- ç¼–è¾‘å™¨UIï¼ˆå¯é€‰ï¼‰- å¯æ˜¾ç¤ºIntentä¿¡æ¯\n\n---\n\n## å·²çŸ¥é—®é¢˜å’Œé™åˆ¶\n\n### é™åˆ¶1ï¼šIntentéªŒè¯\n**é—®é¢˜**ï¼šå¦‚æœLLMç”Ÿæˆçš„Intentä¸å®é™…å‚æ•°ä¸ç¬¦ï¼Œç³»ç»Ÿä»ä¼šåº”ç”¨è§„åˆ™\n**ä¾‹å­**ï¼šLLMè¯´"Tornado"ä½†ç»™äº†çˆ†ç‚¸å‚æ•° â†’ ç³»ç»Ÿä¿®æ­£å‚æ•°\n**æ”¹è¿›**ï¼šåç»­å¯æ·»åŠ IntentéªŒè¯å™¨\n\n### é™åˆ¶2ï¼šTornadoå‚æ•°ç¡¬ç¼–ç \n**é—®é¢˜**ï¼š3å±‚çš„å‚æ•°åœ¨ä»£ç ä¸­ç¡¬ç¼–ç \n**æ”¹è¿›**ï¼šåç»­å¯ä»é…ç½®æ–‡ä»¶è¯»å–\n\n### é™åˆ¶3ï¼šMotion Modelæœªåœ¨Niagaraä¸­å®ç°\n**é—®é¢˜**ï¼šMotion Modelæ˜¯è¯­ä¹‰çš„ï¼Œéœ€è¦åœ¨å®é™…Niagaraæ¨¡å—ä¸­å®ç°\n**ä¾‹å­**ï¼šVortexæ¨¡å‹éœ€è¦Orbit/Vortexå¼ºåˆ¶åœ¨Niagaraä¸­å®ç°\n**æ”¹è¿›**ï¼šåç»­é˜¶æ®µå®ç°\n\n---\n\n## è¿ç§»æŒ‡å—\n\n### å¯¹ç°æœ‰ä»£ç çš„å½±å“\n**æ— å½±å“**ã€‚æ‰€æœ‰ç°æœ‰ä»£ç ç»§ç»­å·¥ä½œã€‚\n\n### æ–°ä»£ç çš„ä½¿ç”¨\n```cpp\n// æ—§æ–¹å¼ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰\nFVFXRecipe Recipe;\nRecipe.Layers.Add(...);\n\n// æ–°æ–¹å¼ï¼ˆæ¨èï¼‰\nFVFXRecipe Recipe;\nRecipe.Intent.Archetype = EVFXArchetype::Tornado;  // æ–°å¢\nRecipe.Layers.Add(...);  // ç°æœ‰\n```\n\n### ä½¿ç”¨æ–°åŠŸèƒ½çš„æ­¥éª¤\n1. è®¾ç½® Recipe.Intent.Archetype\n2. è®¾ç½® Recipe.Intent.Motionï¼ˆå¯é€‰ï¼‰\n3. è®¾ç½® Recipe.Intent.Avoidanceï¼ˆå¯é€‰ï¼‰\n4. è°ƒç”¨ ValidateAndSanitize()\n5. è§„åˆ™è‡ªåŠ¨åº”ç”¨\n\n---\n\n## å‘å¸ƒè®¡åˆ’\n\n### Phase 1: æ ¸å¿ƒå®ç° âœ…\n- [x] Intentæ•°æ®ç»“æ„\n- [x] ApplyArchetypeRuleså‡½æ•°\n- [x] Tornadoè§„åˆ™\n- [x] ä¸¤é˜¶æ®µæç¤ºè¯\n- [x] æ–‡æ¡£\n\n### Phase 2: æ‰©å±•ï¼ˆå»ºè®®ï¼‰\n- [ ] Fireè§„åˆ™å®ç°\n- [ ] Explosionè§„åˆ™å®ç°\n- [ ] å…¶ä»–archetypeè§„åˆ™\n- [ ] UIé›†æˆï¼ˆæ˜¾ç¤ºArchetypeï¼‰\n\n### Phase 3: ä¼˜åŒ–ï¼ˆæœªæ¥ï¼‰\n- [ ] IntentéªŒè¯å™¨\n- [ ] é…ç½®æ–‡ä»¶æ”¯æŒ\n- [ ] Niagaraæ¨¡å—çº§å®ç°ï¼ˆVortex, Centripetalç­‰ï¼‰\n- [ ] å¯è§†åŒ–debugger\n\n---\n\n## è´¡çŒ®è€…\n- VFX Director System æ¶æ„è®¾è®¡å’Œå®ç°\n- å®Œæ•´æ–‡æ¡£ç¼–å†™\n- æµ‹è¯•æ–¹æ¡ˆè®¾è®¡\n\n---\n\n## è®¸å¯å’Œä½¿ç”¨\nVFXAgent é¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚éµå¾ªé¡¹ç›®ç°æœ‰è®¸å¯ã€‚\n\n---\n\n## è”ç³»å’Œæ”¯æŒ\nè¯¦è§å„æ–‡æ¡£çš„å¯¹åº”éƒ¨åˆ†ã€‚\n\n